# üîê ODL-TOOLS - DOCUMENTATION MASTER COMPL√àTE
**Date**: 2025-10-24 22:55:49
**Version**: 1.0.0
**Statut**: PRODUCTION ACTIVE

> ‚ö†Ô∏è **DOCUMENT CRITIQUE**: Ce document contient TOUTES les informations n√©cessaires pour reconstruire l'application ODL-TOOLS √† l'identique from scratch. Gardez-le en s√©curit√©.

---

## üìã TABLE DES MATI√àRES

1. [Credentials & Acc√®s](#1-credentials--acc√®s)
2. [Infrastructure Serveur](#2-infrastructure-serveur)
3. [Base de Donn√©es Supabase](#3-base-de-donn√©es-supabase)
4. [Application Principale](#4-application-principale-appodl-toolsch)
5. [TAR Calculator](#5-tar-calculator-tarodl-toolsch)
6. [Notes de Frais](#6-notes-de-frais-ndfodl-toolsch)
7. [Transport Calculator](#7-transport-calculator-nouveau)
8. [Customs Calculator](#8-customs-calculator-nouveau)
9. [D√©ploiement](#9-d√©ploiement)
10. [Maintenance](#10-maintenance)

---

## 1. CREDENTIALS & ACC√àS

### üîë Serveur SSH
```bash
Host: 31.97.193.159
User: root
SSH Key: ~/.ssh/claude_temp_key
Command: ssh -i ~/.ssh/claude_temp_key root@31.97.193.159
```

### üóÑÔ∏è Supabase (Production)
```bash
Project ID: xewnzetqvrovqjcvwkus
URL: https://xewnzetqvrovqjcvwkus.supabase.co

SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX.XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX.XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

Dashboard: https://supabase.com/dashboard/project/xewnzetqvrovqjcvwkus
```

### ü§ñ Anthropic API
```bash
ANTHROPIC_API_KEY=sk-ant-api03-XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
```

### üåê Domaines en Production
```
app.odl-tools.ch        ‚Üí Application principale (Next.js)
tar.odl-tools.ch        ‚Üí TAR Calculator (Express)
ndf.odl-tools.ch        ‚Üí Notes de Frais frontend (Nginx)
ndf-api.odl-tools.ch    ‚Üí Notes de Frais API (Express)
```

### üë§ Compte Admin Supabase
```
Email: admin@admin.fr
Nom: Administrateur
D√©partement: TOP MANAGEMENT
Poste: CEO
is_super_admin: true
```

---

## 2. INFRASTRUCTURE SERVEUR

### üì¶ Conteneurs Docker Actifs (10)
```bash
odl-tools-app      ‚Üí Next.js 15 (app.odl-tools.ch)
tar-calculator     ‚Üí Express + Claude (tar.odl-tools.ch)
ndf                ‚Üí Nginx statique (ndf.odl-tools.ch)
ndf-api            ‚Üí Express + Vision (ndf-api.odl-tools.ch)
root_traefik_1     ‚Üí Reverse proxy HTTPS
root_n8n_1         ‚Üí Workflow automation
root_odl-tools_1   ‚Üí Socat proxy
root_tar-web_1     ‚Üí Nginx TAR
root_tar-api_1     ‚Üí Socat TAR
tmp_test-http_1    ‚Üí Socat test
```

### üê≥ Docker Compose (/root/docker-compose.odl.yml)
```yaml
version: '3.8'

services:
  odl-tools-app:
    build:
      context: /opt/odl-tools
      dockerfile: Dockerfile
      args:
          NEXT_PUBLIC_SUPABASE_URL: ${SUPABASE_URL}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
          NEXT_PUBLIC_SITE_URL: https://app.odl-tools.ch
    container_name: odl-tools-app
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_SUPABASE_URL=${SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - NEXT_PUBLIC_SITE_URL=https://app.odl-tools.ch
    networks:
      - root_default
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.odl-tools.rule=Host(`app.odl-tools.ch`)"
      - "traefik.http.routers.odl-tools.entrypoints=websecure"
      - "traefik.http.routers.odl-tools.tls=true"
      - "traefik.http.routers.odl-tools.tls.certresolver=mytlschallenge"
      - "traefik.http.services.odl-tools.loadbalancer.server.port=3001"

  tar-calculator:
    build:
      context: /opt/tar-calculator
      dockerfile: Dockerfile
    container_name: tar-calculator
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - PORT=3000
    networks:
      - root_default
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.tar.rule=Host(`tar.odl-tools.ch`)"
      - "traefik.http.routers.tar.entrypoints=websecure"
      - "traefik.http.routers.tar.tls=true"
      - "traefik.http.routers.tar.tls.certresolver=mytlschallenge"
      - "traefik.http.services.tar.loadbalancer.server.port=3000"

  ndf:
    build:
      context: /opt/note-de-frais
      dockerfile: Dockerfile
    container_name: ndf
    restart: unless-stopped
    networks:
      - root_default
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ndf.rule=Host(`ndf.odl-tools.ch`)"
      - "traefik.http.routers.ndf.entrypoints=websecure"
      - "traefik.http.routers.ndf.tls=true"
      - "traefik.http.routers.ndf.tls.certresolver=mytlschallenge"
      - "traefik.http.services.ndf.loadbalancer.server.port=80"

  ndf-api:
    build:
      context: /opt/note-de-frais
      dockerfile: Dockerfile.api
    container_name: ndf-api
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3002
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
    networks:
      - root_default
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ndf-api.rule=Host(`ndf-api.odl-tools.ch`)"
      - "traefik.http.routers.ndf-api.entrypoints=websecure"
      - "traefik.http.routers.ndf-api.tls=true"
      - "traefik.http.routers.ndf-api.tls.certresolver=mytlschallenge"
      - "traefik.http.services.ndf-api.loadbalancer.server.port=3002"

networks:
  root_default:
    external: true
```

### üìÅ Structure Serveur
```
/root/
  ‚îú‚îÄ‚îÄ docker-compose.odl.yml    # Config Docker Compose
  ‚îú‚îÄ‚îÄ .env.odl                  # Variables d'environnement
  ‚îî‚îÄ‚îÄ docker-compose.yml        # Traefik + N8N (NE PAS TOUCHER)

/opt/
  ‚îú‚îÄ‚îÄ odl-tools/               # Application Next.js
  ‚îú‚îÄ‚îÄ tar-calculator/          # TAR Calculator
  ‚îî‚îÄ‚îÄ note-de-frais/           # Notes de Frais
```

### üîÑ Commandes D√©ploiement
```bash
# Se connecter au serveur
ssh -i ~/.ssh/claude_temp_key root@31.97.193.159

# Rebuild et red√©marrer
cd /root
docker-compose -f docker-compose.odl.yml --env-file .env.odl build --no-cache odl-tools-app
docker stop odl-tools-app && docker rm odl-tools-app
docker-compose -f docker-compose.odl.yml --env-file .env.odl up -d odl-tools-app

# Logs
docker logs odl-tools-app --tail 50
```

---

## 3. BASE DE DONN√âES SUPABASE

### üìä Sch√©ma Complet (24 Tables)

#### Tables Core (17)
```sql
1. profiles                  -- Profils utilisateurs
2. applications             -- Demandes d'acc√®s
3. factures                 -- Factures
4. departments              -- D√©partements
5. job_titles              -- Postes
6. api_usage_logs          -- Logs API
7. image_conversions       -- Conversions d'images
8. translations            -- Traductions
9. translation_requests    -- Demandes de traduction
10. game_scores            -- Scores Tetris
11. sso_configurations     -- Config SSO
12. user_sso_mapping       -- Mapping SSO
13. activity_logs          -- Logs activit√©
14. password_resets        -- R√©initialisation mot de passe
15. email_templates        -- Templates email
16. system_settings        -- Param√®tres syst√®me
17. audit_logs             -- Audit trail
```

#### Tables Logistics (7)
```sql
1. customs_fees            -- Frais de douane
2. customs_providers       -- Fournisseurs douane
3. logistics_calculations  -- Calculs logistiques
4. logistics_providers     -- Fournisseurs logistiques
5. logistics_rates         -- Tarifs logistiques
6. pallet_formats          -- Formats de palettes
7. shipping_formats        -- Formats d'exp√©dition
```

### üîß Fonctions SQL Principales (15+)

#### Logistics & Transport
```sql
1. calculate_transport_cost_with_optimization()
   - Calcul complet des co√ªts de transport
   - Optimisation palettes + cartons
   - Orientation 3D des produits
   - Retourne: costs, pallet_info, customer_optimization

2. calculate_pallet_requirements()
   - Calcul arrangement sur palettes
   - Test 3 orientations (L√óW/H, L√óH/W, W√óH/L)
   - Compte la hauteur physique palette (15.2cm)
   - Retourne: products_per_layer, layers, orientation_used

3. calculate_customer_transport_optimization()
   - Optimisation pour le client final
   - Comparaison cartons vs palettes
   - Orientation 3D avec dimensions

4. calculate_logistics_cost()
   - Frais logistiques uniquement

5. calculate_customs_cost()
   - Frais de douane uniquement
```

### üìù Migrations SQL (13 fichiers)

**Liste chronologique**:
```
1. 20251023154916_logistics_calculator_schema.sql
2. 20251023154917_logistics_seed_data.sql
3. 20251023160000_add_quantity_to_logistics.sql
4. 20251023161500_add_rls_logistics.sql
5. 20251023163000_split_transport_customs.sql
6. 20251023170000_add_pallet_calculations.sql
7. 20251023171000_fix_transport_with_pallets.sql
8. 20251023184000_remove_customer_optimization.sql
9. 20251023190000_create_customer_transport_optimization.sql
10. 20251023191000_update_planzer_weight_limit.sql
11. 20251024000000_add_orientation_to_pallet_calc.sql
12. 20251024000001_add_pallet_height.sql
13. 20251024000002_add_orientation_to_customer_optimization.sql
```

#### Migration Critique: Pallet Height (20251024000001)
```sql
-- Ajoute la hauteur physique de la palette
ALTER TABLE pallet_formats
ADD COLUMN IF NOT EXISTS pallet_height_cm NUMERIC DEFAULT 15.2;

-- Mise √† jour Euro Palette
UPDATE pallet_formats
SET pallet_height_cm = 15.2
WHERE pallet_format_id = 'euro';

-- Dans calculate_pallet_requirements:
v_available_height := v_pallet_height - v_pallet_physical_height;
v_orientation_layers := FLOOR(v_available_height / p_product_height_cm);
```

### üå± Seed Data

#### Logistics Provider
```sql
INSERT INTO logistics_providers VALUES (
  'ohmex',
  'Ohmex Logistics',
  'Fournisseur principal de logistique',
  TRUE,
  10.0,  -- Marge 10%
  8.1    -- TVA 8.1%
);
```

#### Logistics Rates (13 tarifs)
```sql
-- Planzer Sans signature
('planzer', 'Planzer', 'Sans signature', '60x60x100 cm', 60, 60, 100, 30, 11.50)
('planzer', 'Planzer', 'Sans signature', '80x60x100 cm', 80, 60, 100, 30, 12.00)
('planzer', 'Planzer', 'Sans signature', '120x80x100 cm', 120, 80, 100, 30, 13.50)
-- ... etc

-- Planzer Avec signature
('planzer', 'Planzer', 'Avec signature', '60x60x100 cm', 60, 60, 100, 30, 12.50)
-- ... etc
```

#### Pallet Format
```sql
INSERT INTO pallet_formats VALUES (
  'euro',
  'Euro Palette',
  120, 80, 200,  -- L √ó W √ó H cm
  1000,          -- Max weight kg
  15.2,          -- Pallet physical height
  TRUE,
  NOW()
);
```

---

## 4. APPLICATION PRINCIPALE (app.odl-tools.ch)

### üéØ Stack Technique
```json
{
  "framework": "Next.js 15.5.5",
  "language": "TypeScript 5.9.3",
  "ui": "React 19.2.0",
  "styling": "Tailwind CSS 3.4.1",
  "backend": "Supabase",
  "auth": "Supabase Auth + SSO Custom",
  "icons": "Lucide React"
}
```

### üì¶ Dependencies Compl√®tes
```json
{
  "dependencies": {
    "@supabase/auth-helpers-nextjs": "^0.10.0",
    "@supabase/ssr": "^0.7.0",
    "@supabase/supabase-js": "^2.75.0",
    "@types/node": "^24.7.2",
    "@types/react": "^19.2.2",
    "autoprefixer": "^10.4.21",
    "class-variance-authority": "^0.7.0",
    "clsx": "^2.1.0",
    "lucide-react": "^0.446.0",
    "next": "^15.5.4",
    "postcss": "^8.5.6",
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "tailwind-merge": "^2.5.0",
    "tailwindcss": "^3.4.1",
    "typescript": "^5.9.3"
  }
}
```

### üèóÔ∏è Structure Projet
```
odl-tools/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx                      # Layout principal
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx                        # Page d'accueil (redirect)
‚îÇ   ‚îú‚îÄ‚îÄ globals.css                     # Styles globaux
‚îÇ   ‚îú‚îÄ‚îÄ middleware.ts                   # SSO + Auth
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ dashboard/page.tsx              # Dashboard principal
‚îÇ   ‚îú‚îÄ‚îÄ login/page.tsx                  # Page login
‚îÇ   ‚îú‚îÄ‚îÄ onboarding/                     # Onboarding utilisateurs
‚îÇ   ‚îú‚îÄ‚îÄ admin/                          # Pages admin
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx                    # Console admin
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ access-management/          # Gestion acc√®s
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ profile-validation/         # Validation profils
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ transport-calculator/           # üÜï Calculateur transport
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ admin/page.tsx
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ customs-calculator/             # üÜï Calculateur douane
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ admin/page.tsx
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/                       # Auth endpoints
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin/                      # Admin endpoints
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ calculate-transport/        # üÜï API Transport
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ calculate-logistics/        # üÜï API Logistics
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ calculate-customs/          # üÜï API Customs
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ tetris/                         # Jeu Tetris
‚îÇ   ‚îú‚îÄ‚îÄ image-converter-test/           # Test conversion images
‚îÇ   ‚îú‚îÄ‚îÄ translation-test/               # Test traduction
‚îÇ   ‚îú‚îÄ‚îÄ api-docs/                       # Documentation API
‚îÇ   ‚îî‚îÄ‚îÄ setup-account/                  # Configuration compte
‚îÇ
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ ui/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AppCard.tsx                 # Card pour dashboard
‚îÇ   ‚îú‚îÄ‚îÄ PackingVisualization.tsx        # üÜï Visualisation 3D
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ supabase-server.ts              # Client Supabase serveur
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ supabase/
‚îÇ   ‚îî‚îÄ‚îÄ migrations/                     # 13 migrations SQL
‚îÇ
‚îú‚îÄ‚îÄ Dockerfile                          # Multi-stage build
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ next.config.js
‚îú‚îÄ‚îÄ tailwind.config.ts
‚îú‚îÄ‚îÄ tsconfig.json
‚îî‚îÄ‚îÄ .env.local                          # Dev env vars
```

### üîê Middleware SSO (middleware.ts)
```typescript
// Logique d'authentification compl√®te
// - V√©rifie session Supabase
// - Charge profil utilisateur
// - V√©rifie statut (blocked, pending, approved)
// - Prot√®ge routes admin (super_admin uniquement)
// - Redirections automatiques
```

### üé® Dashboard (8 Outils)
```typescript
const apps = [
  {
    id: 'tar',
    title: 'TAR Calculator',
    url: 'https://tar.odl-tools.ch',
    gradient: 'from-blue-500 to-blue-700'
  },
  {
    id: 'transport',
    title: 'Calculateur Transport',
    url: '/transport-calculator',
    gradient: 'from-cyan-500 to-blue-700',
    badge: 'Nouveau'
  },
  {
    id: 'customs',
    title: 'Calculateur Douane',
    url: '/customs-calculator',
    gradient: 'from-purple-500 to-indigo-600',
    badge: 'Nouveau'
  },
  {
    id: 'ndf',
    title: 'Notes de Frais',
    url: 'https://ndf.odl-tools.ch',
    gradient: 'from-emerald-500 to-teal-700'
  },
  {
    id: 'api-docs',
    title: 'API Documentation',
    url: '/api-docs',
    gradient: 'from-indigo-500 to-violet-700'
  },
  {
    id: 'image-converter',
    title: 'Image Converter Test',
    url: '/image-converter-test',
    gradient: 'from-purple-500 to-pink-600'
  },
  {
    id: 'translation',
    title: 'Traduction Test',
    url: '/translation-test',
    gradient: 'from-orange-500 to-red-600'
  },
  {
    id: 'tetris',
    title: 'Tetris',
    url: '/tetris',
    gradient: 'from-pink-500 to-purple-600'
  }
]
```

---

## 5. TAR CALCULATOR (tar.odl-tools.ch)

### üßÆ Fonctionnalit√©
Calcul automatique des taxes de recyclage suisses pour les appareils √©lectroniques.

### üèóÔ∏è Stack
- **Backend**: Express.js + Claude API (Anthropic)
- **Frontend**: HTML/CSS/JS statique
- **Base de donn√©es**: Supabase

### üìç Emplacement Serveur
```
/opt/tar-calculator/
```

### ‚öôÔ∏è Logique
1. User entre type de produit + EAN + description
2. API utilise Claude pour identifier cat√©gorie TAR
3. Retourne organisme (SWICO/SENS) + montant + cat√©gorie

---

## 6. NOTES DE FRAIS (ndf.odl-tools.ch)

### üíº Fonctionnalit√©
Gestion et validation des notes de frais avec OCR Claude Vision.

### üèóÔ∏è Architecture
```
Frontend (ndf.odl-tools.ch)
  ‚îú‚îÄ‚îÄ Nginx statique
  ‚îî‚îÄ‚îÄ Interface upload + validation

API (ndf-api.odl-tools.ch)
  ‚îú‚îÄ‚îÄ Express.js
  ‚îú‚îÄ‚îÄ Claude Vision API
  ‚îî‚îÄ‚îÄ Extraction automatique donn√©es facture
```

### üìç Emplacements Serveur
```
/opt/note-de-frais/
  ‚îú‚îÄ‚îÄ Dockerfile         # Frontend Nginx
  ‚îî‚îÄ‚îÄ Dockerfile.api     # Backend Express
```

---

## 7. TRANSPORT CALCULATOR (Nouveau)

### üöö Fonctionnalit√© Compl√®te
- Calcul co√ªts transport (Planzer)
- Optimisation palettes Euro (120√ó80√ó200cm)
- Visualisation 3D produits dans palettes
- Orientation automatique 3D (L√óW/H, L√óH/W, W√óH/L)
- Calcul hauteur disponible (200cm - 15.2cm palette)

### üìä API Endpoint
```typescript
POST /api/calculate-transport

Body: {
  length_cm: number,
  width_cm: number,
  height_cm: number,
  weight_kg: number,
  quantity: number,
  carrier?: string,        // 'planzer' ou null (auto)
  mode?: string,          // 'Sans signature' ou null (auto)
  provider_id?: string,   // 'ohmex' (default)
  pallet_format_id?: string  // 'euro' (default)
}

Response: {
  success: boolean,
  costs: {
    transport: {
      base: number,
      margin: number,
      tva: number,
      subtotal: number,
      per_unit: number,
      carrier: string,
      mode: string
    },
    total_per_unit: number,
    delivery_options: Array<{...}>
  },
  pallet_info: {
    pallet_format: {...},
    calculation: {
      products_per_layer: number,
      layers_per_pallet: number,
      products_per_pallet_final: number,
      pallets_needed: number,
      efficiency_percent: number,
      orientation_used: 1|2|3,
      product_base_length: number,
      product_base_width: number,
      product_stack_height: number
    }
  },
  customer_optimization: {...}
}
```

### üé® Composant PackingVisualization.tsx
```typescript
// Visualisation 3D des produits dans palette
// - Vue de dessus (1 couche)
// - Vue lat√©rale (empilement)
// - Calcul automatique dimensions affichage
// - Swap dimensions selon orientation choisie
// - Scroll horizontal si palette trop large
// - Affichage espace vide

Props:
  containerLength: number
  containerWidth: number
  containerHeight: number
  productLength: number
  productWidth: number
  productHeight: number
  productsPerLayer: number
  layersPerContainer: number
  containerType: string
  productBaseLength?: number      // De SQL
  productBaseWidth?: number       // De SQL
  productStackHeight?: number     // De SQL
  orientationUsed?: 1|2|3        // De SQL
  availableHeight?: number        // 184.8cm pour Euro
  palletHeight?: number           // 15.2cm pour Euro
```

### üîß Logique Orientation
```typescript
// Option 1: L√óW base, H stacked
perRow = floor(120 / productLength)
perCol = floor(80 / productWidth)
layers = floor(184.8 / productHeight)

// Option 2: L√óH base, W stacked
perRow = floor(120 / productLength)
perCol = floor(80 / productHeight)
layers = floor(184.8 / productWidth)

// Option 3: W√óH base, L stacked
perRow = floor(120 / productWidth)
perCol = floor(80 / productHeight)
layers = floor(184.8 / productLength)

// Choisir la meilleure capacit√©
best = max(option1.total, option2.total, option3.total)
```

---

## 8. CUSTOMS CALCULATOR (Nouveau)

### üåç Fonctionnalit√©
Calcul des frais de douane pour importations.

### üìä API Endpoint
```typescript
POST /api/calculate-customs

Body: {
  value_chf: number,
  weight_kg: number,
  provider_id?: string
}

Response: {
  success: boolean,
  costs: {
    admin_fee: number,
    vat: number,
    total: number
  }
}
```

---

## 9. D√âPLOIEMENT

### üî® Build Local ‚Üí Production

#### √âtape 1: Transfer Files
```bash
# Fichiers modifi√©s
scp -i ~/.ssh/claude_temp_key \
  app/transport-calculator/page.tsx \
  root@31.97.193.159:/opt/odl-tools/app/transport-calculator/

scp -i ~/.ssh/claude_temp_key \
  components/PackingVisualization.tsx \
  root@31.97.193.159:/opt/odl-tools/components/
```

#### √âtape 2: Build Docker
```bash
ssh -i ~/.ssh/claude_temp_key root@31.97.193.159

cd /root
docker-compose -f docker-compose.odl.yml --env-file .env.odl build --no-cache odl-tools-app
```

#### √âtape 3: Recreate Container
```bash
docker stop odl-tools-app
docker rm odl-tools-app
docker-compose -f docker-compose.odl.yml --env-file .env.odl up -d odl-tools-app
```

#### √âtape 4: Verify
```bash
docker logs odl-tools-app --tail 50
curl -I https://app.odl-tools.ch/transport-calculator
```

### üìù Dockerfile (Multi-Stage)
```dockerfile
FROM node:20-alpine AS base

# Stage 1: Dependencies
FROM base AS deps
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

# Stage 2: Builder
FROM base AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .

ARG NEXT_PUBLIC_SUPABASE_URL
ARG NEXT_PUBLIC_SUPABASE_ANON_KEY
ARG NEXT_PUBLIC_SITE_URL

ENV NEXT_PUBLIC_SUPABASE_URL=$NEXT_PUBLIC_SUPABASE_URL
ENV NEXT_PUBLIC_SUPABASE_ANON_KEY=$NEXT_PUBLIC_SUPABASE_ANON_KEY
ENV NEXT_PUBLIC_SITE_URL=$NEXT_PUBLIC_SITE_URL

RUN npm run build

# Stage 3: Runner
FROM base AS runner
WORKDIR /app
ENV NODE_ENV=production

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs
EXPOSE 3001
ENV PORT=3001

CMD ["node", "server.js"]
```

### üóÑÔ∏è Migrations Supabase
```bash
# Appliquer migration
supabase db push --db-url "postgresql://postgres.xewnzetqvrovqjcvwkus:PASSWORD@aws-0-eu-central-1.pooler.supabase.com:6543/postgres"

# Ordre d'application (IMPORTANT):
1. 20251023154916_logistics_calculator_schema.sql
2. 20251023154917_logistics_seed_data.sql
3. ... (dans l'ordre chronologique)
13. 20251024000002_add_orientation_to_customer_optimization.sql
```

---

## 10. MAINTENANCE

### üîç Logs
```bash
# Application logs
docker logs odl-tools-app --tail 100 --follow

# Traefik logs
docker logs root_traefik_1 --tail 50

# Tous les conteneurs
docker ps -a
```

### üîÑ Restart Services
```bash
# Restart app
docker restart odl-tools-app

# Restart all ODL services
cd /root
docker-compose -f docker-compose.odl.yml restart
```

### üíæ Backup
```bash
# Backup application
ssh -i ~/.ssh/claude_temp_key root@31.97.193.159
tar czf odl-tools-backup-$(date +%Y%m%d).tar.gz /opt/odl-tools

# Backup database (via Supabase Dashboard)
# https://supabase.com/dashboard/project/xewnzetqvrovqjcvwkus/settings/general
```

### üö® Troubleshooting

#### App ne d√©marre pas
```bash
# V√©rifier logs
docker logs odl-tools-app

# V√©rifier variables env
docker exec odl-tools-app env | grep SUPABASE

# Rebuild complet
docker-compose -f docker-compose.odl.yml --env-file .env.odl build --no-cache odl-tools-app
```

#### 404 sur nouvelle route
```bash
# V√©rifier que fichiers sont sur serveur
ls /opt/odl-tools/app/transport-calculator/

# V√©rifier dans conteneur
docker exec odl-tools-app ls .next/server/app/transport-calculator/

# Si absent: rebuild n√©cessaire
```

#### Cache Next.js
```bash
# Sur serveur, supprimer cache
docker exec odl-tools-app rm -rf .next/cache

# Rebuild
docker restart odl-tools-app
```

---

## üìö FICHIERS DE R√âF√âRENCE

### Configuration Files
- `package.json` - Dependencies exactes
- `next.config.js` - Config Next.js
- `tailwind.config.ts` - Config Tailwind
- `middleware.ts` - Auth & SSO logic
- `Dockerfile` - Multi-stage build
- `docker-compose.odl.yml` - Orchestration

### Documentation Existante
- `ARCHITECTURE-SSO.md` - Architecture SSO
- `DEPLOYMENT-GUIDE.md` - Guide d√©ploiement
- `DESIGN-SYSTEM.md` - Design system
- `PROJECT-STRUCTURE.md` - Structure projet
- `SERVER-ANALYSIS.md` - Analyse serveur

---

## ‚úÖ CHECKLIST RECONSTRUCTION

Pour reconstruire ODL-TOOLS from scratch:

### 1. Serveur & Infrastructure
- [ ] Provisionner serveur Ubuntu
- [ ] Installer Docker + Docker Compose
- [ ] Configurer Traefik reverse proxy
- [ ] Configurer domaines DNS (app.odl-tools.ch, etc.)
- [ ] G√©n√©rer certificats SSL (Let's Encrypt)

### 2. Supabase
- [ ] Cr√©er projet Supabase
- [ ] Appliquer 13 migrations dans l'ordre
- [ ] Ins√©rer seed data (providers, rates, pallet formats)
- [ ] Cr√©er compte admin (admin@admin.fr)
- [ ] Copier ANON_KEY + SERVICE_ROLE_KEY

### 3. Application Next.js
- [ ] Cloner structure projet
- [ ] `npm install` dependencies
- [ ] Cr√©er .env.local avec credentials
- [ ] D√©velopper/copier toutes les pages
- [ ] D√©velopper/copier tous les composants
- [ ] Tester en local (PORT=3003)

### 4. APIs
- [ ] Impl√©menter /api/calculate-transport
- [ ] Impl√©menter /api/calculate-logistics
- [ ] Impl√©menter /api/calculate-customs
- [ ] Tester endpoints

### 5. D√©ploiement
- [ ] Cr√©er Dockerfile
- [ ] Cr√©er docker-compose.odl.yml
- [ ] Cr√©er .env.odl sur serveur
- [ ] Upload code vers /opt/odl-tools
- [ ] Build image Docker
- [ ] Lancer conteneur
- [ ] V√©rifier HTTPS fonctionne

### 6. Services Additionnels
- [ ] D√©ployer TAR Calculator
- [ ] D√©ployer Notes de Frais
- [ ] Configurer N8N si n√©cessaire

---

## üîí S√âCURIT√â

### Secrets √† NE JAMAIS COMMIT
- ‚ùå SUPABASE_SERVICE_ROLE_KEY
- ‚ùå ANTHROPIC_API_KEY
- ‚ùå SSH Private Key
- ‚ùå .env files

### Best Practices
- ‚úÖ Variables d'environnement via Docker
- ‚úÖ HTTPS partout (Traefik)
- ‚úÖ RLS activ√© sur Supabase
- ‚úÖ Middleware auth sur toutes routes prot√©g√©es
- ‚úÖ Validation input API

---

## üìû SUPPORT

### En cas de probl√®me

1. **V√©rifier logs**: `docker logs odl-tools-app`
2. **V√©rifier documentation**: Lire les .md existants
3. **V√©rifier Supabase**: Dashboard Supabase pour DB
4. **Rebuild**: Souvent r√©sout les probl√®mes de cache

### Contact
- **Serveur**: root@31.97.193.159
- **Supabase**: https://supabase.com/dashboard/project/xewnzetqvrovqjcvwkus

---

**FIN DU DOCUMENT MASTER**

*Ce document contient TOUTES les informations n√©cessaires pour reconstruire ODL-TOOLS √† l'identique.*
